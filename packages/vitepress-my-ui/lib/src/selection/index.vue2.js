"use strict";Object.defineProperties(exports,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}});const n=require("vue"),c=require("../utils/utils.js"),j=n.defineComponent({name:"Selection",emits:["update:modelValue","custHandle"],props:{modelValue:{type:Boolean,default:!1},selectKey:{type:String,default:""},title:{type:String,default:""},showFormList:{type:Object,default:{code:{key:"code",label:"编码",isShow:!0,type:"input"},name:{key:"name",label:"名称",isShow:!0,type:"input"}}},showTableList:{type:Object,default:{code:{key:"code",label:"编码",isShow:!0},name:{key:"name",label:"名称",isShow:!0}}},isRadio:{type:Boolean,default:!0},checkTable:{type:Array,default:[]},rowKey:{type:String,default:"id"},confirmClose:{type:Boolean,default:!0},fetchUrl:{type:Function},renderFunc:{type:Function,default:a=>a},dealFetchFunc:{type:Function,default:a=>a},initValue:{type:Object,default:{}},defaultValue:{type:Object,default:{}},hasPagination:{type:Boolean,default:!0},initialDataSource:{type:Array,default:()=>[]},staticData:{type:Object,default:{}}},setup(a,{emit:s}){const{hooksCommonState:r,currentChange:g,sizeChange:S}=c.getCommonState(),e=n.reactive({formList:[],formListBackup:[],tableList:[],tableListBackup:[],form:{},tableData:[],selectTableData:[],searchFormRef:n.ref(null),multipleTable:n.ref(null),dialogWidth:1e3,extendAttributes:[],disabledId:"",dialogTop:"8vh",activeName:"first",dialogRef:n.ref(""),hasInitialDataSource:!1});e.hasInitialDataSource=n.computed(()=>{var t;return((t=a.initialDataSource)==null?void 0:t.length)>0});const p=t=>{t==="confirm"?(s("custHandle",{visible:!1,list:e.selectTableData||[],type:a.selectKey}),a.confirmClose&&(s("update:modelValue",!1),e.multipleTable.clearSelection(),e.form={})):(s("update:modelValue",!1),e.multipleTable.clearSelection(),e.form={})},D=t=>{a.isRadio?(t&&Object.keys(t).length>0&&(s("custHandle",{visible:!1,list:[t]||[],rowData:t,type:a.selectKey}),s("update:modelValue",!1),e.selectTableData=[],e.multipleTable.clearSelection()),e.form={}):e.multipleTable.toggleRowSelection(t)},T=t=>{e.selectTableData=t},L=t=>{e.multipleTable.toggleRowSelection(e.multipleTable.getSelectionRows().find(o=>o[a.rowKey]==t[a.rowKey]),!1),e.selectTableData=e.selectTableData.filter(o=>o[a.rowKey]!==t[a.rowKey])},f=()=>{e.tableData=c.deepClone(a.initialDataSource).filter(t=>{var o;return(o=Object.keys(e.form))==null?void 0:o.every(l=>["string"].includes(typeof e.form[l])?t[l].includes(e.form[l]):["object"].includes(typeof e.form[l])?e.form[l].includes(t[l]):t[l]==e.form[l])})},h=()=>{e.hasInitialDataSource?f():(r.pager.currentPage=1,d())},w=()=>{e.form={...a.defaultValue},e.hasInitialDataSource?f():h()},d=async()=>{if(a.fetchUrl)try{let t=c.deepClone(e.form);r.tableLoading=!0;const o=r.pager.currentPage,l=r.pager.pageSize;e.formList.filter(i=>i.type==="modalTextarea").map(i=>{t[i.key]&&(t[i.key]=e.form[i.key].split(","))});let u=a.hasPagination?{currentPage:o,pageSize:l,...t}:{...t};a.fetchUrl(a.dealFetchFunc(u)).then(i=>{const{data:m=[],count:b=0}=a.renderFunc(i);e.tableData=m,r.tableLoading=!1,r.pager.total=b})}catch(t){e.tableData=[],r.pager.total=0,console.log("%c error","color: chartreuse",t),r.tableLoading=!1}},C=t=>{t==null||t.forEach(o=>{e.multipleTable.toggleRowSelection(o)}),e.selectTableData=t},y=(t,o)=>{var u;let l=[];return(u=Object.keys(t))==null||u.map(i=>{if(typeof t[i]=="boolean"&&t[i]){let m=o.find(b=>b.key==i)||[];l.push({...m,isShow:!0})}else typeof t[i]=="object"&&l.push({isShow:!0,...t[i]})}),l},F=()=>{e.activeName="first";const t=a.checkTable;t.length>0&&C(t),e.form={...a.initValue,...a.defaultValue},!a.fetchUrl&&e.hasInitialDataSource?f():(e.tableData=[],d()),r.pager.currentPage=1,r.pager.total=0},v=()=>{e.activeName="first"};return n.watch(()=>a.showFormList,()=>{e.formList=c.deepClone(y(a.showFormList,e.formListBackup))},{immediate:!0,deep:!0}),n.watch(()=>a.showTableList,()=>{e.tableList=c.deepClone(y(a.showTableList,e.tableListBackup))},{immediate:!0,deep:!0}),{...n.toRefs(e),...n.toRefs(a),...n.toRefs(r),handleClose:p,getData:d,resetInfo:w,handleOpen:F,currentChange:g,sizeChange:S,searchData:h,handleSelectionChange:T,removeSelectData:L,rowClick:D,toFirstTab:v}},components:{SearchForm:n.defineAsyncComponent(()=>Promise.resolve().then(()=>require("../search-form/index.vue.js"))),ThePagination:n.defineAsyncComponent(()=>Promise.resolve().then(()=>require("../the-pagination/index.vue.js")))}});exports.default=j;
